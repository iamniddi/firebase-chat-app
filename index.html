<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üí¨ Discord Style Chat</title>
  <style>
    body {
      font-family: Arial;
      margin: 0;
      padding: 0;
      background: #2f3136;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #auth {
      padding: 10px;
      text-align: center;
      background: #202225;
    }
    h2 {
      text-align: center;
      margin: 8px 0;
    }
    #chatBox {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .message-group {
      display: flex;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    .profile-pic {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .content {
      display: flex;
      flex-direction: column;
      max-width: 75%;
    }
    .username {
      font-weight: bold;
      color: #00b0f4;
      margin-right: 6px;
    }
    .timestamp {
      color: #999;
      font-size: 10px;
      align-self: flex-end;
    }
    .message {
      background: #40444b;
      padding: 8px;
      border-radius: 6px;
      margin-top: 4px;
      word-break: break-word;
    }
    #inputArea {
      display: flex;
      padding: 10px;
      background: #36393f;
    }
    #message {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      margin-right: 8px;
      font-size: 14px;
      resize: none;            /* ÌÅ¨Í∏∞ Í≥†Ï†ï */
      height: 40px;            /* Í≥†Ï†ï ÎÜíÏù¥ */
    }
    #sendBtn {
      padding: 0 16px;
      border: none;
      border-radius: 6px;
      background: #5865f2;
      color: #fff;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="auth"></div>
  <h2>üí¨ Real-Time Chat</h2>
  <div id="chatBox"></div>
  <div id="inputArea" style="display:none;">
    <textarea id="message" placeholder="Type a message..." rows="1"></textarea>
    <button id="sendBtn" onclick="sendMessage()">Send</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // 1) Firebase Ï¥àÍ∏∞Ìôî
    const firebaseConfig = {
      apiKey: "AIzaSyA6C9AQ1kUtxTILR6v8mmlQkuz9UTHjHv0",
      authDomain: "notion-chat-c7ff1.firebaseapp.com",
      projectId: "notion-chat-c7ff1",
      storageBucket: "notion-chat-c7ff1.appspot.com",
      messagingSenderId: "1052307211297",
      appId: "1:1052307211297:web:aa81f9649cf607202c8f60"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 2) DOM Ï∞∏Ï°∞
    const authDiv = document.getElementById('auth');
    const chatBox = document.getElementById('chatBox');
    const inputArea = document.getElementById('inputArea');
    const messageField = document.getElementById('message');

    // 3) Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú Ïú†ÏßÄ
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    auth.onAuthStateChanged(user => {
      if (user) {
        authDiv.innerHTML = `<p>üë§ ${user.displayName} <button onclick="logout()">Logout</button></p>`;
        inputArea.style.display = 'flex';
        loadMessages();
      } else {
        authDiv.innerHTML = `<button onclick="login()">Login with Google</button>`;
        inputArea.style.display = 'none';
      }
    });

    function login() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    }
    function logout() {
      auth.signOut();
    }

    // 4) Î©îÏãúÏßÄ Î≥¥ÎÇ¥Í∏∞ (ÏóîÌÑ∞ÌÇ§ Ï†ÑÏÜ° Ìè¨Ìï®)
    function sendMessage() {
      const text = messageField.value.trim();
      if (!text) return;
      const user = auth.currentUser;
      db.collection("messages").add({
        userName: user.displayName,
        userPhoto: user.photoURL,
        message: text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        messageField.value = '';
      });
    }
    messageField.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // 5) Î©îÏãúÏßÄ Î°úÎìú & Í∑∏Î£πÌïë
    function loadMessages() {
      db.collection("messages").orderBy("timestamp")
        .onSnapshot(snap => {
          // Ïä§ÎÉÖÏÉ∑ÏúºÎ°ú Í∑∏Î£π Î∞∞Ïó¥ ÎßåÎì§Í∏∞
          const groups = [];
          snap.forEach(doc => {
            const d = doc.data();
            const ts = d.timestamp ? d.timestamp.toDate() : new Date();
            const hh = ts.getHours();
            const mm = ts.getMinutes().toString().padStart(2, '0');
            const time = `${hh}:${mm}`;
            const key = `${d.userName}|${time}`;

            if (groups.length && groups[groups.length-1].key === key) {
              groups[groups.length-1].messages.push(d.message);
            } else {
              groups.push({
                key,
                userName: d.userName,
                userPhoto: d.userPhoto,
                time,
                messages: [d.message]
              });
            }
          });

          // HTML Î†åÎçîÎßÅ
          chatBox.innerHTML = '';
          groups.forEach(g => {
            let html = `
              <div class="message-group">
                <img class="profile-pic" src="${g.userPhoto}" alt="Profile">
                <div class="content">
                  <div>
                    <span class="username">${g.userName}</span>
                    <span class="timestamp">${g.time}</span>
                  </div>`;
            g.messages.forEach(msg =>
              html += `<div class="message">${msg}</div>`
            );
            html += `</div></div>`;
            chatBox.innerHTML += html;
          });
          chatBox.scrollTop = chatBox.scrollHeight;
        });
    }
  </script>
</body>
</html>
