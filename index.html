<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>💬 Firebase Real-Time Chat</title>
  <style>
    body { font-family: Arial; max-width: 400px; margin: auto; padding: 20px; text-align: center; }
    #chatBox { border-top: 1px solid #ddd; margin-top: 20px; height: 400px; overflow-y: scroll; text-align: left; }
    .message-group { margin-bottom: 15px; }
    .username { font-weight: bold; margin-bottom: 5px; }
    .message { margin-left: 20px; }
    textarea { width: 100%; margin-top: 10px; padding: 8px; }
    button { margin-top: 10px; padding: 10px; width: 100%; }
  </style>
</head>
<body>
  <h2>💬 Real-Time Chat</h2>
  <div id="auth"></div>
  <div id="chat" style="display:none;">
    <textarea id="message" placeholder="Type a message..." rows="3"></textarea><br>
    <button onclick="sendMessage()">Send</button>
    <div id="chatBox"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebase Config (본인 프로젝트 값으로 교체)
    const firebaseConfig = {
      apiKey: "AIzaSyA6C9AQ1kUtxTILR6v8mmlQkuz9UTHjHv0",
      authDomain: "notion-chat-c7ff1.firebaseapp.com",
      projectId: "notion-chat-c7ff1",
      storageBucket: "notion-chat-c7ff1.appspot.com",
      messagingSenderId: "1052307211297",
      appId: "1:1052307211297:web:aa81f9649cf607202c8f60"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const authDiv = document.getElementById('auth');
    const chatDiv = document.getElementById('chat');
    const chatBox = document.getElementById('chatBox');

    // 자동 로그인 유지 설정
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    auth.onAuthStateChanged(user => {
      if (user) {
        authDiv.innerHTML = `<p>👤 ${user.displayName} <button onclick="logout()">Logout</button></p>`;
        chatDiv.style.display = 'block';
        loadMessages();
      } else {
        authDiv.innerHTML = `<button onclick="login()">Login with Google</button>`;
        chatDiv.style.display = 'none';
      }
    });

    function login() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    }

    function logout() {
      auth.signOut();
    }

    function sendMessage() {
      const messageField = document.getElementById('message');
      const message = messageField.value.trim();
      if (!message) return;

      const user = auth.currentUser;
      db.collection("messages").add({
        userName: user.displayName,
        userPhoto: user.photoURL,
        message: message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        messageField.value = '';
      });
    }

    // 엔터키로 메시지 전송
    document.getElementById('message').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    function loadMessages() {
      db.collection("messages").orderBy("timestamp")
        .onSnapshot(snapshot => {
          chatBox.innerHTML = '';
          let lastUser = null;

          snapshot.forEach(doc => {
            const data = doc.data();

            if (lastUser !== data.userName) {
              chatBox.innerHTML += `
                <div class="message-group">
                  <div class="username">${data.userName}</div>
                  <div class="message">${data.message}</div>
                </div>`;
              lastUser = data.userName;
            } else {
              chatBox.innerHTML += `<div class="message">${data.message}</div>`;
            }
          });

          chatBox.scrollTop = chatBox.scrollHeight;
        });
    }
  </script>
</body>
</html>
